{% load static %}

<!DOCTYPE html>
<html>
<head>
    <meta name="description" content="Google Maps tool for tracking plant population observations." />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <link rel="shortcut icon" type="image/png" href="{% static 'img/favicon.ico' %}"/>

    <script src="{% static 'jquery/jquery-1.10.2.js' %}" type="text/javascript"></script>
    <script src="{% static 'js/jquery-ui-1.10.4.custom.min.js' %}" type="text/javascript"></script>

    {# Get Shit Done #}
    <link href="{% static 'bootstrap3/css/bootstrap.css' %}" rel="stylesheet" />
    <link href="{% static 'css/gsdk.css' %}" rel="stylesheet" />
    <link href="{% static 'css/live.css' %}" rel="stylesheet" />
    <script src="https://use.fontawesome.com/e81afb5b7a.js"></script>
    <script src="{% static 'js/gsdk-checkbox.js' %}"></script>
    <script src="{% static 'js/gsdk-radio.js' %}"></script>
    <script src="{% static 'js/gsdk-bootstrapswitch.js' %}"></script>
    <script src="{% static 'js/get-shit-done.js' %}"></script>

    <link rel="stylesheet" href="{% static 'tracker/css/tracker.css' %}">

    <!-- Google Analytics -->
    <script>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

        ga('create', 'UA-100638725-1', 'auto');
        ga('send', 'pageview');
    </script>

    <title>CTS Mapper</title>
</head>
<body>

<div class="container">
    <div class="text-center">
        <a href="/">
            <img class="tracker-logo" src="{% static "img/cts_bold_shadow.png" %}">
        </a>
    </div>
</div>

<!-- The form to upload GPX files from a GPS device. -->
<form class="tracker-form" enctype="multipart/form-data" method="post" action="{% url 'tracker:upload' %}">
    {% csrf_token %}
    {% for field in form %}
        <label class="btn btn-default btn-file" for="{{ field.name }}">
            <div id="label-text">{{ field.label }}</div>
            {{ field }}
        </label>
    {% endfor %}
    <button class="btn btn-primary disabled" id="upload-btn" type="submit">Upload GPX</button>
</form>

<!-- The actual map -->
<div id="map"></div>

<div class="tracker container-fluid">
    <div id=waypoints>
        {{content}}
    </div>
    <button class="btn btn-primary" id="saveWaypoints" type="submit">Save</button>
    <div class="space-30"></div>
    <div>
        <input type="text" title="address" class="form-control" id="address" value="Salt Lake City, UT">
    </div>
    <button class="btn btn-default form-control" id="searchWaypoints" type="submit">
        Rank waypoints by distance from address
    </button>

    <div class="tracker-layers">
        <div class="pstz">
            <div class="col-sm-3">
                <input id="pstz_slider" type="checkbox" data-toggle="switch" class="ct-green"/>
            </div>
            <div class="col-sm-9 tracker-layer-label">
                <label for="pstz_slider" class="">Add Provisional Seed Transfer Zones</label>
            </div>
        </div>
    </div>

</div>

<script>
    let map;
    let geocoder;
    let pstz = false;
    let loading = false;
    let infoWindow;
</script>
<script type="text/javascript" src="{% static 'tracker/js/map.js'%}"></script>
<script async defer
        src="https://maps.googleapis.com/maps/api/js?key={{ maps_api_key }}&callback=initMap">
</script>
<script>
    // Change Browse button text to filename
    $(function() {
        $("#id_file").change(function() {
            let input = $(this),
                label = input.val().replace(/\\/g, '/').replace(/.*\//, '');
            allowUpload(label);
        });

        function allowUpload(label) {
            if (label.split('.')[1] !== 'gpx') {
                alert("You must select a valid GPX file.")
            } else {
                $("#label-text").text(label);
                $('#upload-btn').toggleClass('disabled');
            }
        }
    });
</script>

<script>
    let userMarker;
    let waypointByID = {};
    let currentObject;

    {% for waypoint in waypoints %}
        waypointByID[{{waypoint.id}}] = {
            name: "{{waypoint.name}}",
            lat: {{waypoint.geometry.y}},
            lng: {{waypoint.geometry.x}}
        };
    {% endfor %}

    $('')
    $(document).ready(function () {
        function activateWaypoints() {
            // Add waypoint click handler
            $('.waypoint').each(function () {
                $(this).click(function() {
                    var waypoint = waypointByID[this.id];
                    var new_center = new google.maps.LatLng(waypoint.lat, waypoint.lng);
                    currentObject = $(this);
                    if (userMarker) userMarker.setMap();
                    userMarker = new google.maps.Marker({map: map, position: new_center, draggable: true});
                    google.maps.event.addListener(userMarker, 'dragend', function () {
                        var position = userMarker.getPosition();
                        waypoint.lat = position.lat();
                        waypoint.lng = position.lng();
                        currentObject.html(waypoint.name +
                            ' (' + waypoint.lat +
                            ', ' + waypoint.lng + ')');
                        $('#saveWaypoints').css('display', 'block');
                    });
                    map.panTo(new_center);
                }).hover(
                    function () {this.className = this.className.replace('OFF', 'ON');},
                    function () {this.className = this.className.replace('ON', 'OFF');}
                );
            });
        }
        function searchWaypoints() {
            geocoder.geocode({
                'address': $('#address').val()
            }, function (results, status) {
                if (status === google.maps.GeocoderStatus.OK) {
                    let position = results[0].geometry.location;
                    $.get("{% url 'tracker:search' %}", {
                        lat: position.lat(),
                        lng: position.lng()
                    }, function (data) {
                        if (data.isOK) {
                            $('#waypoints').html(data.content);
                            waypointByID = data.waypointByID;
                            activateWaypoints();
                        } else {
                            alert(data.message);
                        }
                    }, 'json');
                } else {
                    alert('Could not find geocoordinates for the following reason: ' + status);
                }
            });
        }
        $('#searchWaypoints').click(searchWaypoints);
        $('#address').keydown(function(e) {
            if (e.keyCode === 13) searchWaypoints();
        });
        $('#saveWaypoints').click(function () {
            function getCookie(name) {
                let cookieValue = null;
                if (document.cookie && document.cookie !== '') {
                    let cookies = document.cookie.split(';');
                    for (let i = 0; i < cookies.length; i++) {
                        let cookie = jQuery.trim(cookies[i]);
                        // Does this cookie string begin with the name we want?
                        if (cookie.substring(0, name.length + 1) === (name + '=')) {
                            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                            break;
                        }
                    }
                }
                return cookieValue;
            }
            const csrftoken = getCookie('csrftoken');
            let waypointStrings = [];
            for (id in waypointByID) {
                waypoint = waypointByID[id];
                waypointStrings.push(id + ' ' + waypoint.lng + ' ' + waypoint.lat);
            };
            $.post("{% url 'tracker:save' %}", {
                waypointsPayload: waypointStrings.join('\n'),
                'csrfmiddlewaretoken': csrftoken
            }, function (data) {
                if (data.isOk) {
                    $('#saveWaypoints').attr('disabled', 'disabled');
                } else {
                    alert(data.message);
                }
            });
        });
        activateWaypoints();
    });
</script>

<script>
    // Escapes HTML characters in a template literal string, to prevent XSS.
    // See https://www.owasp.org/index.php/XSS_%28Cross_Site_Scripting%29_Prevention_Cheat_Sheet#RULE_.231_-_HTML_Escape_Before_Inserting_Untrusted_Data_into_HTML_Element_Content
    function sanitizeHTML(strings) {
        const entities = {'&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'};
        let result = strings[0];
        for (let i = 1; i < arguments.length; i++) {
            result += String(arguments[i]).replace(/[&<>'"]/g, (char) => {
                return entities[char];
            });
            result += strings[i];
        }
        return result;
    }

    $(document).ready(function () {
        console.log('document ready.');
        $("#pstz_slider").parent().change(load_pstz);
        function load_pstz() {
            console.log('click detected on pstz slider.');
            if (loading === false && pstz === false && $("#pstz_slider").parent().hasClass("switch-on")) {
                loading = true;
                console.log('the slider is on so fetching json data...');
                map.data.loadGeoJson("{% static 'tracker/data/provision_seed_zones/psz.geojson' %}");

                const pszColors = {
                    "<0 Deg. F. / < 2": "#895943",
                    "<0 Deg. F. / 2 - 3": "#cc8865",
                    "<0 Deg. F. / 3 - 6": "#f67677",
                    "<0 Deg. F. / 6 - 12": "#d7b19e",
                    ">55 Deg. F. / 2 - 3": "#ffffff", {# cross-hatch #}
                    ">55 Deg. F. / 3 - 6": "#ffffff", {# cross-hatch #}
                    "0 - 5 Deg. F. / < 2": "#007370",
                    "0 - 5 Deg. F. / 12 - 30": "#c6e7dc",
                    "0 - 5 Deg. F. / 2 - 3": "#029b98",
                    "0 - 5 Deg. F. / 3 - 6": "#59c39d",
                    "0 - 5 Deg. F. / 6 - 12": "#8cd2c7",
                    "10 - 15 Deg. F. / < 2": "#314c21",
                    "10 - 15 Deg. F. / 12 - 30": "#d6eab9",
                    "10 - 15 Deg. F. / 2 - 3": "#3a8e40",
                    "10 - 15 Deg. F. / 3 - 6": "#69a042",
                    "10 - 15 Deg. F. / 6 - 12": "#aed463",
                    "15 - 20 Deg. F. / < 2": "#73164d",
                    "15 - 20 Deg. F. / 12 - 30": "#f3bfd5",
                    "15 - 20 Deg. F. / 2 - 3": "#a61f85",
                    "15 - 20 Deg. F. / 3 - 6": "#d43498",
                    "15 - 20 Deg. F. / 6 - 12": "#de7bb2",
                    "20 - 25 Deg. F. / < 2": "#676c2c",
                    "20 - 25 Deg. F. / 12 - 30": "#e9f0bc",
                    "20 - 25 Deg. F. / 2 - 3": "#99aa38",
                    "20 - 25 Deg. F. / 3 - 6": "#b5d335",
                    "20 - 25 Deg. F. / 6 - 12": "#d3e26d",
                    "25 - 30 Deg. F. / < 2": "#734d1c",
                    "25 - 30 Deg. F. / > 30": "#ffe9ad",
                    "25 - 30 Deg. F. / 12 - 30": "#ffd17c",
                    "25 - 30 Deg. F. / 2 - 3": "#a67028",
                    "25 - 30 Deg. F. / 3 - 6": "#e79821",
                    "25 - 30 Deg. F. / 6 - 12": "#ffa916",
                    "30 - 35 Deg. F. / < 2": "#710d0f",
                    "30 - 35 Deg. F. / > 30": "#f9bbbe",
                    "30 - 35 Deg. F. / 12 - 30": "#f67a7c",
                    "30 - 35 Deg. F. / 2 - 3": "#a71d1d",
                    "30 - 35 Deg. F. / 3 - 6": "#e71a21",
                    "30 - 35 Deg. F. / 6 - 12": "#f11f20",
                    "35 - 40 Deg. F. / < 2": "#000000",
                    "35 - 40 Deg. F. / > 30": "#e1e1df",
                    "35 - 40 Deg. F. / 12 - 30": "#cccccc",
                    "35 - 40 Deg. F. / 2 - 3": "#4d4d4d",
                    "35 - 40 Deg. F. / 3 - 6": "#828282",
                    "35 - 40 Deg. F. / 6 - 12": "#b3b3b3",
                    "40 - 45 Deg. F. / < 2": "#4b2270",
                    "40 - 45 Deg. F. / > 30": "#dbbedc",
                    "40 - 45 Deg. F. / 12 - 30": "#b57bb6",
                    "40 - 45 Deg. F. / 2 - 3": "#7c2e94",
                    "40 - 45 Deg. F. / 3 - 6": "#894b9e",
                    "40 - 45 Deg. F. / 6 - 12": "#954da1",
                    "45 - 50 Deg. F. / < 2": "#4b2270",
                    "45 - 50 Deg. F. / 12 - 30": "#bfe3f9",
                    "45 - 50 Deg. F. / 2 - 3": "#0585ac",
                    "45 - 50 Deg. F. / 3 - 6": "#00abde",
                    "45 - 50 Deg. F. / 6 - 12": "#7fd4f3",
                    "5 - 10 Deg. F. / < 2": "#21316d",
                    "5 - 10 Deg. F. / 12 - 30": "#c1d0ed",
                    "5 - 10 Deg. F. / 2 - 3": "#114da3",
                    "5 - 10 Deg. F. / 3 - 6": "#3b60ae",
                    "5 - 10 Deg. F. / 6 - 12": "#80acd9",
                    "50 - 55 Deg. F. / 12 - 30": "#a5a835",
                    "50 - 55 Deg. F. / 2 - 3": "#fef9bf",
                    "50 - 55 Deg. F. / 3 - 6": "#e6e415",
                    "50 - 55 Deg. F. / 6 - 12": "#babd32"
                };

                map.data.setStyle(function (feature) {
                    const seedZone = feature.getProperty('seed_zone');
                    return {
                        fillColor: pszColors[seedZone],
                        strokeWidth: 1,
                        strokeOpacity: 0.3
                    }
                });

                map.data.addListener('click', function (event) {
                    const seed_zone = event.feature.getProperty('seed_zone');
                    const content = sanitizeHTML`
                      <div>
                        <h2><strong>Seed Zone</strong>: ${seed_zone}</h2>
                      </div>
                    `;

                    infoWindow.setContent(content);
                    infoWindow.setPosition(event.latLng);
                    infoWindow.open(map);
                });
            }
        }
    });
</script>
</body>
</html>